∏
OC:\Projects\ShopsRUs-Retail-Store\ShopsRUs.Api\Controllers\InvoiceController.cs
	namespace 	
ShopsRUs
 
. 
Api 
. 
Controllers "
{		 
[

 
Route

 

(


 
$str

 
)

 
]

 
[ 
ApiController 
] 
public 

class 
InvoiceController "
:# $
ControllerBase% 3
{ 
private 
readonly 
IInvoiceService (
_invoiceService) 8
;8 9
public 
InvoiceController  
(  !
IInvoiceService! 0
invoiceService1 ?
)? @
{ 	
_invoiceService 
= 
invoiceService ,
;, -
} 	
[ 	
HttpPost	 
( 
$str 
) 
]  
public 
async 
Task 
< 
ActionResult &
<& '
Invoice' .
>. /
>/ 0

GetInvoice1 ;
(; <
InvoiceRequest< J
requestK R
)R S
{ 	
Customer 
customer 
= 
await  %
_invoiceService& 5
.5 6
GetCustomer6 A
(A B
requestB I
.I J

customerIdJ T
)T U
;U V
if 
( 
customer 
is 
null  
)  !
{ 
string 
message 
=  
$str! 5
;5 6
return 
NotFound 
(  
message  '
)' (
;( )
} 
List   
<   
Product   
>   
products   "
=  # $
request  % ,
.  , -
Products  - 5
;  5 6
Invoice"" 
result"" 
="" 
await"" "
_invoiceService""# 2
.""2 3!
CalculateInvoiceAsync""3 H
(""H I
customer""I Q
,""Q R
products""R Z
)""Z [
;""[ \
return$$ 
result$$ 
;$$ 
}%% 	
}&& 
}'' ñ
EC:\Projects\ShopsRUs-Retail-Store\ShopsRUs.Api\Dtos\InvoiceRequest.cs
	namespace 	
ShopsRUs
 
. 
Api 
. 
Dtos 
{ 
public 

class 
InvoiceRequest 
{ 
public		 
int		 

customerId		 
{		 
get		  #
;		# $
set		% (
;		( )
}		* +
public

 
List

 
<

 
Product

 
>

 
Products

 %
{

& '
get

( +
;

+ ,
set

- 0
;

0 1
}

2 3
} 
} º
CC:\Projects\ShopsRUs-Retail-Store\ShopsRUs.Api\Entities\Customer.cs
	namespace 	
ShopsRUs
 
. 
Api 
. 
Entities 
{ 
public 
class 
Customer 
{ 
public 
int 
id 
{ 
get 
; 
set  
;  !
}" #
public

 
string

 
Name

 
{

 
get

  
;

  !
set

" %
;

% &
}

' (
public 
string 
Surname 
{ 
get  #
;# $
set% (
;( )
}* +
public 
CustomerType 
Type  
{! "
get# &
;& '
set( +
;+ ,
}- .
public 
DateTime 
? 
	CreatedAt "
{# $
get% (
;( )
set* -
;- .
}/ 0
} 
} ›	
BC:\Projects\ShopsRUs-Retail-Store\ShopsRUs.Api\Entities\Invoice.cs
	namespace 	
ShopsRUs
 
. 
Api 
. 
Entities 
{ 
public 

class 
Invoice 
{ 
public 
Guid 
id 
{ 
get 
; 
set !
;! "
}# $
public 
Customer 
Customer  
{! "
get# &
;& '
set( +
;+ ,
}- .
public		 
decimal		 
Total		 
{		 
get		 "
;		" #
set		$ '
;		' (
}		) *
public

 
decimal

 
Discount

 
{

  !
get

" %
;

% &
set

' *
;

* +
}

, -
public 
decimal 
NetAmountPayable '
{( )
get* -
;- .
set/ 2
;2 3
}4 5
public 
DateTimeOffset 
createdDate )
{* +
get, /
;/ 0
set1 4
;4 5
}6 7
} 
} ˜
BC:\Projects\ShopsRUs-Retail-Store\ShopsRUs.Api\Entities\Product.cs
	namespace 	
ShopsRUs
 
. 
Api 
. 
Entities 
{ 
public 

class 
Product 
{ 
public 
string 
Name 
{ 
get  
;  !
set" %
;% &
}' (
public

 
ProductType

 
Type

 
{

  !
get

" %
;

% &
set

' *
;

* +
}

, -
public 
decimal 
Price 
{ 
get "
;" #
set$ '
;' (
}) *
} 
} ˆ
DC:\Projects\ShopsRUs-Retail-Store\ShopsRUs.Api\Enums\CustomerType.cs
	namespace 	
ShopsRUs
 
. 
Api 
. 
Enums 
{ 
public 

enum 
CustomerType 
{ 
Employee 
= 
$num 
, 
	Affiliate 
= 
$num 
, 
RegularCustomer		 
=		 
$num		 
}

 
} ¯
CC:\Projects\ShopsRUs-Retail-Store\ShopsRUs.Api\Enums\ProductType.cs
	namespace 	
ShopsRUs
 
. 
Api 
. 
Enums 
{ 
public 

enum 
ProductType 
{ 
	Groceries 
= 
$num 
, 
Sports 
= 
$num 
, 
Electronics		 
=		 
$num		 
,		 
Clothing

 
=

 
$num

 
,

 
Others 
= 
$num 
} 
} √

9C:\Projects\ShopsRUs-Retail-Store\ShopsRUs.Api\Program.cs
	namespace

 	
ShopsRUs


 
.

 
Api

 
{ 
public 

static 
class 
Program 
{ 
public 
static 
void 
Main 
(  
string  &
[& '
]' (
args) -
)- .
{ 	
CreateHostBuilder 
( 
args "
)" #
.# $
Build$ )
() *
)* +
.+ ,
Run, /
(/ 0
)0 1
;1 2
} 	
public 
static 
IHostBuilder "
CreateHostBuilder# 4
(4 5
string5 ;
[; <
]< =
args> B
)B C
=>D F
Host 
.  
CreateDefaultBuilder %
(% &
args& *
)* +
. $
ConfigureWebHostDefaults )
() *

webBuilder* 4
=>5 7
{ 

webBuilder 
. 

UseStartup )
<) *
Startup* 1
>1 2
(2 3
)3 4
;4 5
} 
) 
; 
} 
} ö
IC:\Projects\ShopsRUs-Retail-Store\ShopsRUs.Api\Service\IInvoiceService.cs
	namespace 	
ShopsRUs
 
. 
Api 
. 
Service 
{ 
public 

	interface 
IInvoiceService $
{		 
Task

 
<

 
Invoice

 
>

 !
CalculateInvoiceAsync

 +
(

+ ,
Customer

, 4
customer

5 =
,

= >
List

? C
<

C D
Product

D K
>

K L
products

M U
)

U V
;

V W
Task 
< 
Customer 
> 
GetCustomer "
(" #
int# &

customerId' 1
)1 2
;2 3
} 
} ‰C
HC:\Projects\ShopsRUs-Retail-Store\ShopsRUs.Api\Service\InvoiceService.cs
	namespace		 	
ShopsRUs		
 
.		 
Api		 
.		 
Service		 
{

 
public 

class 
InvoiceService 
:  !
IInvoiceService" 1
{ 
private 
readonly 
List 
< 
Customer &
>& '
	customers( 1
=2 3
new4 7
(7 8
)8 9
{ 	
new 
Customer 
{ 
id 
= 
$num  !
,! "
Name# '
=( )
$str* 7
,7 8
Surname9 @
=A B
$strC K
,K L
TypeM Q
=Q R
CustomerTypeS _
._ `
Employee` h
,h i
	CreatedAtj s
=t u
DateTimev ~
.~ 
Now	 Ç
}
É Ñ
,
Ñ Ö
new 
Customer 
{ 
id 
= 
$num  !
,! "
Name# '
=( )
$str* 2
,2 3
Surname4 ;
=< =
$str> F
,F G
TypeH L
=M N
CustomerTypeO [
.[ \
	Affiliate\ e
,e f
	CreatedAtg p
=q r
DateTimes {
.{ |
Now| 
}
Ä Å
,
Å Ç
new 
Customer 
{ 
id 
= 
$num  !
,! "
Name# '
=( )
$str* 3
,3 4
Surname5 <
== >
$str? F
,F G
TypeH L
=M N
CustomerTypeO [
.[ \
RegularCustomer\ k
,k l
	CreatedAtm v
=w x
DateTime	y Å
.
Å Ç
Now
Ç Ö
}
Ü á
,
á à
new 
Customer 
{ 
id 
= 
$num  !
,! "
Name# '
=( )
$str* 1
,1 2
Surname3 :
=; <
$str= E
,E F
TypeG K
=L M
CustomerTypeN Z
.Z [
RegularCustomer[ j
,j k
	CreatedAtl u
=v w
DateTime	x Ä
.
Ä Å
Now
Å Ñ
.
Ñ Ö
AddYears
Ö ç
(
ç é
-
é è
$num
è ê
)
ê ë
}
í ì
,
ì î
} 	
;	 

public 
async 
Task 
< 
Invoice !
>! "!
CalculateInvoiceAsync# 8
(8 9
Customer9 A
customerB J
,J K
ListL P
<P Q
ProductQ X
>X Y
productsZ b
)b c
{ 	
double #
discountPercentageValue *
=+ ,!
GetDiscountPercentage- B
(B C
customerC K
)K L
;L M
decimal 
allItemTotal  
=! "
$num# $
;$ %
decimal 
withoutGroceryTotal '
=( )
$num* +
;+ ,
decimal 
discount 
= 
$num  
;  !
decimal 

grandTotal 
=  
$num! "
;" #
foreach 
( 
var 
product  
in! #
products$ ,
), -
{ 
if   
(   
product   
.   
Type    
!=  ! #
ProductType  $ /
.  / 0
	Groceries  0 9
)  9 :
withoutGroceryTotal!! '
+=!!( *
product!!+ 2
.!!2 3
Price!!3 8
;!!8 9
allItemTotal## 
+=## 
product##  '
.##' (
Price##( -
;##- .
}$$ 
decimal&& 
percantageDiscount&& &
=&&' (
withoutGroceryTotal&&) <
*&&= >
(&&? @
decimal&&@ G
)&&G H#
discountPercentageValue&&H _
;&&_ `
decimal'' 
generalDiscount'' #
=''$ %
(''& '
allItemTotal''' 3
/''4 5
$num''6 9
)''9 :
>=''; =
$num''> ?
?''@ A
(''B C
Convert''C J
.''J K
ToInt32''K R
(''R S
Math''S W
.''W X
Floor''X ]
(''] ^
allItemTotal''^ j
/''k l
$num''m p
)''p q
)''q r
*''s t
$num''u v
)''v w
:''x y
$num''z {
;''{ |
discount)) 
=)) 
percantageDiscount)) )
+))* +
generalDiscount)), ;
;)); <

grandTotal** 
=** 
allItemTotal** %
-**& '
discount**( 0
;**0 1
var,, 
result,, 
=,, 
new,, 
Invoice,, $
{-- 
id.. 
=.. 
Guid.. 
... 
NewGuid.. !
(..! "
).." #
,..# $
Customer// 
=// 
customer// #
,//# $
Total00 
=00 
allItemTotal00 $
,00$ %
Discount11 
=11 
discount11 #
,11# $
NetAmountPayable22  
=22! "

grandTotal22# -
,22- .
createdDate33 
=33 
DateTime33 &
.33& '
Now33' *
,33* +
}44 
;44 
return66 
await66 
Task66 
.66 

FromResult66 (
(66( )
result66) /
)66/ 0
;660 1
}77 	
private99 
static99 
double99 !
GetDiscountPercentage99 3
(993 4
Customer994 <
customer99= E
)99E F
{:: 	
CustomerType;; 
customerType;; %
=;;& '
customer;;( 0
.;;0 1
Type;;1 5
;;;5 6
bool<< 
isOverTwoYears<< 
=<<  !
customer<<" *
.<<* +
	CreatedAt<<+ 4
.<<4 5
HasValue<<5 =
&&<<> @
(<<A B
DateTime<<B J
.<<J K
Now<<K N
><<O P
customer<<Q Y
.<<Y Z
	CreatedAt<<Z c
.<<c d
Value<<d i
.<<i j
AddYears<<j r
(<<r s
$num<<s t
)<<t u
)<<u v
;<<v w
double== 

percentage== 
=== 
$num==  !
;==! "
switch?? 
(?? 
customerType??  
)??  !
{@@ 
caseAA 
CustomerTypeAA !
.AA! "
EmployeeAA" *
:AA* +

percentageBB 
=BB  
$numBB! %
;BB% &
breakCC 
;CC 
caseDD 
CustomerTypeDD !
.DD! "
	AffiliateDD" +
:DD+ ,

percentageEE 
=EE  
$numEE! %
;EE% &
breakFF 
;FF 
caseGG 
CustomerTypeGG !
.GG! "
RegularCustomerGG" 1
:GG1 2
ifHH 
(HH 
isOverTwoYearsHH &
)HH& '

percentageII "
=II# $
$numII% )
;II) *
breakJJ 
;JJ 
defaultKK 
:KK 
breakLL 
;LL 
}MM 
returnOO 

percentageOO 
;OO 
}PP 	
publicRR 
asyncRR 
TaskRR 
<RR 
CustomerRR "
>RR" #
GetCustomerRR$ /
(RR/ 0
intRR0 3

customerIdRR4 >
)RR> ?
{SS 	
CustomerTT 
customerTT 
=TT 
	customersTT  )
.TT) *
SingleOrDefaultTT* 9
(TT9 :
cTT: ;
=>TT< >
cTT? @
.TT@ A
idTTA C
==TTD F

customerIdTTG Q
)TTQ R
;TTR S
ifVV 
(VV 
customerVV 
isVV 
nullVV  
)VV  !
returnWW 
nullWW 
;WW 
returnYY 
awaitYY 
TaskYY 
.YY 

FromResultYY (
(YY( )
customerYY) 1
)YY1 2
;YY2 3
}ZZ 	
}[[ 
}\\ Ú
9C:\Projects\ShopsRUs-Retail-Store\ShopsRUs.Api\Startup.cs
	namespace 	
ShopsRUs
 
. 
Api 
{ 
public 

class 
Startup 
{ 
public 
Startup 
( 
IConfiguration %
configuration& 3
)3 4
{ 	
Configuration 
= 
configuration )
;) *
} 	
public 
IConfiguration 
Configuration +
{, -
get. 1
;1 2
}3 4
public 
void 
ConfigureServices %
(% &
IServiceCollection& 8
services9 A
)A B
{ 	
services   
.   
AddFluentValidation   (
(  ( )
x  ) *
=>  + -
x  . /
.  / 04
(RegisterValidatorsFromAssemblyContaining  0 X
<  X Y#
InvoiceRequestValidator  Y p
>  p q
(  q r
)  r s
)  s t
;  t u
services!! 
.!! 
	AddScoped!! 
<!! 
IInvoiceService!! .
,!!. /
InvoiceService!!0 >
>!!> ?
(!!? @
)!!@ A
;!!A B
services"" 
."" 
AddControllers"" #
(""# $
)""$ %
;""% &
services## 
.## 
AddSwaggerGen## "
(##" #
c### $
=>##% '
{$$ 
c%% 
.%% 

SwaggerDoc%% 
(%% 
$str%% !
,%%! "
new%%# &
OpenApiInfo%%' 2
{%%3 4
Title%%5 :
=%%; <
$str%%= K
,%%K L
Version%%M T
=%%U V
$str%%W [
}%%\ ]
)%%] ^
;%%^ _
}&& 
)&& 
;&& 
}'' 	
public** 
void** 
	Configure** 
(** 
IApplicationBuilder** 1
app**2 5
,**5 6
IWebHostEnvironment**7 J
env**K N
)**N O
{++ 	
if,, 
(,, 
env,, 
.,, 
IsDevelopment,, !
(,,! "
),," #
),,# $
{-- 
app.. 
... %
UseDeveloperExceptionPage.. -
(..- .
)... /
;../ 0
app// 
.// 

UseSwagger// 
(// 
)//  
;//  !
app00 
.00 
UseSwaggerUI00  
(00  !
c00! "
=>00# %
c00& '
.00' (
SwaggerEndpoint00( 7
(007 8
$str008 R
,00R S
$str00T e
)00e f
)00f g
;00g h
}11 
app33 
.33 
UseHttpsRedirection33 #
(33# $
)33$ %
;33% &
app55 
.55 

UseRouting55 
(55 
)55 
;55 
app77 
.77 
UseAuthorization77  
(77  !
)77! "
;77" #
app99 
.99 
UseEndpoints99 
(99 
	endpoints99 &
=>99' )
{:: 
	endpoints;; 
.;; 
MapControllers;; (
(;;( )
);;) *
;;;* +
}<< 
)<< 
;<< 
}== 	
}>> 
}?? Œ
TC:\Projects\ShopsRUs-Retail-Store\ShopsRUs.Api\Validation\InvoiceRequestValidator.cs
	namespace 	
ShopsRUs
 
. 
Api 
. 

Validation !
{ 
public 

class #
InvoiceRequestValidator (
:) *
AbstractValidator+ <
<< =
InvoiceRequest= K
>K L
{ 
public		 #
InvoiceRequestValidator		 &
(		& '
)		' (
{

 	
RuleFor 
( 
c 
=> 
c 
. 

customerId %
)% &
.& '
NotEmpty' /
(/ 0
)0 1
.1 2
WithMessage2 =
(= >
$str> h
)h i
;i j
RuleFor 
( 
c 
=> 
c 
. 

customerId %
)% &
.& '
GreaterThan' 2
(2 3
$num3 4
)4 5
.5 6
WithMessage6 A
(A B
$strB e
)e f
;f g
RuleFor 
( 
c 
=> 
c 
. 
Products #
)# $
.$ %
NotEmpty% -
(- .
). /
./ 0
WithMessage0 ;
(; <
$str< p
)p q
;q r
RuleFor 
( 
c 
=> 
c 
. 
Products #
.# $
Count$ )
)) *
.* +
GreaterThan+ 6
(6 7
$num7 8
)8 9
.9 :
WithMessage: E
(E F
$strF z
)z {
;{ |
RuleForEach 
( 
c 
=> 
c 
. 
Products '
)' (
.( )
SetValidator) 5
(5 6
new6 9
ProductValidator: J
(J K
)K L
)L M
;M N
} 	
public 
class 
ProductValidator %
:& '
AbstractValidator( 9
<9 :
Product: A
>A B
{ 	
public 
ProductValidator #
(# $
)$ %
{ 
RuleFor 
( 
c 
=> 
c 
. 
Type #
)# $
.$ %
NotEmpty% -
(- .
). /
./ 0
WithMessage0 ;
(; <
$str< i
)i j
.j k
IsInEnumk s
(s t
)t u
.u v
WithMessage	v Å
(
Å Ç
$str
Ç ®
)
® ©
;
© ™
RuleFor 
( 
c 
=> 
c 
. 
Price $
)$ %
.% &
NotEmpty& .
(. /
)/ 0
.0 1
WithMessage1 <
(< =
$str= k
)k l
.l m
GreaterThanm x
(x y
$numy z
)z {
.{ |
WithMessage	| á
(
á à
$str
à •
)
• ¶
;
¶ ß
}   
}!! 	
}"" 
}## 